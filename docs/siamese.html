---

title: Siamese model for name ambiguation


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/08_siamese.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/08_siamese.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here, in this notebook, we will create a model that can tell the difference between "Paul" &amp; "Paula". This model can be used as a drop in replacement to string comparison methods which can return score from 0 to 1 depending upon the similarity. For example, here is the intended use:</p>
<blockquote><p>compare("Paul", "Paula") -&gt; 0.3  # It indicates different gender</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">alt_names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/name_pairs.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name_a&#39;</span><span class="p">,</span><span class="s1">&#39;name_b&#39;</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">alt_names</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name_a</th>
      <th>name_b</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>16048</th>
      <td>Tine</td>
      <td>Martin</td>
    </tr>
    <tr>
      <th>8327</th>
      <td>Kristin</td>
      <td>Krissy</td>
    </tr>
    <tr>
      <th>305</th>
      <td>Ale</td>
      <td>Alisha</td>
    </tr>
    <tr>
      <th>2914</th>
      <td>Clifton</td>
      <td>Tone</td>
    </tr>
    <tr>
      <th>4824</th>
      <td>Foncho</td>
      <td>Fon</td>
    </tr>
    <tr>
      <th>13622</th>
      <td>Radisa</td>
      <td>Radomirm</td>
    </tr>
    <tr>
      <th>2792</th>
      <td>Chus</td>
      <td>Suso</td>
    </tr>
    <tr>
      <th>4543</th>
      <td>Erma</td>
      <td>Em</td>
    </tr>
    <tr>
      <th>9708</th>
      <td>Madzia</td>
      <td>Magdzia</td>
    </tr>
    <tr>
      <th>2643</th>
      <td>Chema</td>
      <td>Josemaria</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>


<span class="k">def</span> <span class="nf">syllables</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="c1"># single syllable word</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[aeiouy]&#39;</span><span class="p">,</span> <span class="n">word</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">word</span><span class="p">]</span>

    <span class="c1"># sonority hierarchy: vowels, nasals, fricatives, stops</span>
    <span class="n">hierarchy</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">syllables_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">word</span><span class="p">]</span>

    <span class="n">syllables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">syll</span> <span class="o">=</span> <span class="n">syllables_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">trigram</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">syllables_values</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]):</span>
        <span class="p">(</span><span class="n">phonemes</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">trigram</span><span class="p">)</span>
        <span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">following</span><span class="p">)</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">phoneme</span> <span class="o">=</span> <span class="n">phonemes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">previous</span> <span class="o">&gt;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">following</span><span class="p">:</span>
            <span class="n">syllables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syll</span><span class="p">)</span>
            <span class="n">syll</span> <span class="o">=</span> <span class="n">phoneme</span>
        <span class="k">elif</span> <span class="n">previous</span> <span class="o">&gt;=</span> <span class="n">val</span> <span class="o">==</span> <span class="n">following</span><span class="p">:</span>
            <span class="n">syll</span> <span class="o">+=</span> <span class="n">phoneme</span>
            <span class="n">syllables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syll</span><span class="p">)</span>
            <span class="n">syll</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">syll</span> <span class="o">+=</span> <span class="n">phoneme</span>
    <span class="n">syll</span> <span class="o">+=</span> <span class="n">syllables_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">syllables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syll</span><span class="p">)</span>

    <span class="n">final_syllables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">front</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">syllable</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">syllables</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;[aeiouy]&#39;</span><span class="p">,</span> <span class="n">syllable</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_syllables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">front</span> <span class="o">+=</span> <span class="n">syllable</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_syllables</span> <span class="o">=</span> <span class="n">final_syllables</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> \
                                  <span class="o">+</span> <span class="p">[</span><span class="n">final_syllables</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">syllable</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_syllables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">final_syllables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">front</span> <span class="o">+</span> <span class="n">syllable</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_syllables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syllable</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_syllables</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">unidecode</span>
<span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="kn">import</span> <span class="n">fuzz</span>

<span class="kn">from</span> <span class="nn">abydos.distance</span> <span class="kn">import</span> <span class="p">(</span><span class="n">IterativeSubString</span><span class="p">,</span> <span class="n">BISIM</span><span class="p">,</span> <span class="n">DiscountedLevenshtein</span><span class="p">,</span> <span class="n">Prefix</span><span class="p">,</span> <span class="n">LCSstr</span><span class="p">,</span> <span class="n">MLIPNS</span><span class="p">,</span> <span class="n">Strcmp95</span><span class="p">,</span>
<span class="n">MRA</span><span class="p">,</span> <span class="n">Editex</span><span class="p">,</span> <span class="n">SAPS</span><span class="p">,</span> <span class="n">FlexMetric</span><span class="p">,</span> <span class="n">JaroWinkler</span><span class="p">,</span> <span class="n">HigueraMico</span><span class="p">,</span> <span class="n">Sift4</span><span class="p">,</span> <span class="n">Eudex</span><span class="p">,</span> <span class="n">ALINE</span><span class="p">,</span> <span class="n">Covington</span><span class="p">,</span> <span class="n">PhoneticEditDistance</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">abydos.phonetic</span> <span class="kn">import</span> <span class="n">PSHPSoundexFirst</span><span class="p">,</span> <span class="n">Ainsworth</span>
<span class="n">pshp_soundex_first</span> <span class="o">=</span> <span class="n">PSHPSoundexFirst</span><span class="p">()</span>
<span class="n">pe</span> <span class="o">=</span> <span class="n">Ainsworth</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/puneet/Envs/venv/lib/python3.9/site-packages/fuzzywuzzy/fuzz.py:11: UserWarning: Using slow pure-python SequenceMatcher. Install python-Levenshtein to remove this warning
  warnings.warn(&#39;Using slow pure-python SequenceMatcher. Install python-Levenshtein to remove this warning&#39;)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">abydos.phones</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">iss</span> <span class="o">=</span> <span class="n">IterativeSubString</span><span class="p">()</span>
<span class="n">bisim</span> <span class="o">=</span> <span class="n">BISIM</span><span class="p">()</span>
<span class="n">dlev</span> <span class="o">=</span> <span class="n">DiscountedLevenshtein</span><span class="p">()</span>
<span class="n">prefix</span> <span class="o">=</span> <span class="n">Prefix</span><span class="p">()</span>
<span class="n">lcs</span> <span class="o">=</span> <span class="n">LCSstr</span><span class="p">()</span>
<span class="n">mlipns</span> <span class="o">=</span> <span class="n">MLIPNS</span><span class="p">()</span>
<span class="n">strcmp95</span> <span class="o">=</span> <span class="n">Strcmp95</span><span class="p">()</span>
<span class="n">mra</span> <span class="o">=</span> <span class="n">MRA</span><span class="p">()</span>
<span class="n">editex</span> <span class="o">=</span> <span class="n">Editex</span><span class="p">()</span>
<span class="n">saps</span> <span class="o">=</span> <span class="n">SAPS</span><span class="p">()</span>
<span class="n">flexmetric</span> <span class="o">=</span> <span class="n">FlexMetric</span><span class="p">()</span>
<span class="n">jaro</span> <span class="o">=</span> <span class="n">JaroWinkler</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;Jaro&#39;</span><span class="p">)</span>
<span class="n">higuera_mico</span> <span class="o">=</span> <span class="n">HigueraMico</span><span class="p">()</span>
<span class="n">sift4</span> <span class="o">=</span> <span class="n">Sift4</span><span class="p">()</span>
<span class="n">eudex</span> <span class="o">=</span> <span class="n">Eudex</span><span class="p">()</span>
<span class="n">aline</span> <span class="o">=</span> <span class="n">ALINE</span><span class="p">()</span>
<span class="n">covington</span> <span class="o">=</span> <span class="n">Covington</span><span class="p">()</span>
<span class="n">phonetic_edit</span> <span class="o">=</span> <span class="n">PhoneticEditDistance</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">algos</span> <span class="o">=</span> <span class="p">[</span><span class="n">iss</span><span class="p">,</span> <span class="n">bisim</span><span class="p">,</span> <span class="n">dlev</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">lcs</span><span class="p">,</span> <span class="n">mlipns</span><span class="p">,</span> <span class="n">strcmp95</span><span class="p">,</span> <span class="n">mra</span><span class="p">,</span> <span class="n">editex</span><span class="p">,</span> <span class="n">saps</span><span class="p">,</span> <span class="n">flexmetric</span><span class="p">,</span> <span class="n">jaro</span><span class="p">,</span> <span class="n">higuera_mico</span><span class="p">,</span> <span class="n">sift4</span><span class="p">,</span> <span class="n">eudex</span><span class="p">,</span>
         <span class="n">aline</span><span class="p">,</span> <span class="n">covington</span><span class="p">,</span> <span class="n">phonetic_edit</span><span class="p">]</span>

<span class="n">algo_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;iterativesubstring&#39;</span><span class="p">,</span> <span class="s1">&#39;bisim&#39;</span><span class="p">,</span> <span class="s1">&#39;discountedlevenshtein&#39;</span><span class="p">,</span> <span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;lcsstr&#39;</span><span class="p">,</span> <span class="s1">&#39;mlipns&#39;</span><span class="p">,</span> <span class="s1">&#39;strcmp95&#39;</span><span class="p">,</span> <span class="s1">&#39;mra&#39;</span><span class="p">,</span>
              <span class="s1">&#39;editex&#39;</span><span class="p">,</span> <span class="s1">&#39;saps&#39;</span><span class="p">,</span> <span class="s1">&#39;flexmetric&#39;</span><span class="p">,</span> <span class="s1">&#39;jaro&#39;</span><span class="p">,</span> <span class="s1">&#39;higueramico&#39;</span><span class="p">,</span> <span class="s1">&#39;sift4&#39;</span><span class="p">,</span> <span class="s1">&#39;eudex&#39;</span><span class="p">,</span> <span class="s1">&#39;aline&#39;</span><span class="p">,</span> <span class="s1">&#39;covington&#39;</span><span class="p">,</span>
              <span class="s1">&#39;phoneticeditdistance&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sum_ipa</span><span class="p">(</span><span class="n">name_a</span><span class="p">,</span> <span class="n">name_b</span><span class="p">):</span>
    <span class="n">feat1</span> <span class="o">=</span> <span class="n">ipa_to_features</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">name_a</span><span class="p">))</span>
    <span class="n">feat2</span> <span class="o">=</span> <span class="n">ipa_to_features</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">name_b</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cmp_features</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">)</span> <span class="k">for</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">feat1</span><span class="p">,</span> <span class="n">feat2</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">feat1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">score</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="k">def</span> <span class="nf">featurize</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="s1">&#39;b&#39;</span> <span class="p">})</span>
        
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;name_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
        <span class="s1">&#39;[^a-zA-Z]+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">unidecode</span><span class="o">.</span><span class="n">unidecode</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;name_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
        <span class="s1">&#39;[^a-zA-Z]+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">unidecode</span><span class="o">.</span><span class="n">unidecode</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;syll_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">syllables</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name_a</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;syll_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">syllables</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;partial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">partial_ratio</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">syll_a</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">syll_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tkn_sort&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">token_sort_ratio</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">syll_a</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">syll_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tkn_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">token_set_ratio</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">syll_a</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">syll_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sum_ipa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">sum_ipa</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name_a</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pshp_soundex_first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pshp_soundex_first</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name_a</span><span class="p">)</span><span class="o">==</span><span class="n">pshp_soundex_first</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name_b</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">algo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">algos</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="n">algo_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">algo</span><span class="o">.</span><span class="n">sim</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name_a</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;syll_a&#39;</span><span class="p">,</span> <span class="s1">&#39;syll_b&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">alt_names</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

<span class="c1"># Use combinatorics to generate negative class</span>
<span class="n">all_names</span> <span class="o">=</span> <span class="n">alt_names</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;name_a&#39;</span><span class="p">:</span><span class="s1">&#39;name_b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">unique_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">all_names</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]))</span>
<span class="n">alt_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">alt_names</span><span class="o">.</span><span class="n">name_a</span><span class="p">,</span> <span class="n">alt_names</span><span class="o">.</span><span class="n">name_b</span><span class="p">))</span><span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">alt_names</span><span class="o">.</span><span class="n">name_b</span><span class="p">,</span> <span class="n">alt_names</span><span class="o">.</span><span class="n">name_a</span><span class="p">))</span>
<span class="n">comb</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">unique_names</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">non_alt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">alt_pairs</span><span class="p">))</span>
<span class="c1"># Undersample the negative class for 1:4 class imbalance instead of 1:1000 extreme class imbalance</span>
<span class="n">non_alt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">non_alt</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">70040</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name_a&#39;</span><span class="p">,</span> <span class="s1">&#39;name_b&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;positive class ratio 1:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">non_alt</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">alt_names</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>positive class ratio 1:4
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">non_alt</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">alt_names</span><span class="p">,</span> <span class="n">non_alt</span><span class="p">])</span>
<span class="n">non_alt</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">alt_names</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">featurize</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>target</th>
      <th>name_a</th>
      <th>name_b</th>
      <th>partial</th>
      <th>tkn_sort</th>
      <th>tkn_set</th>
      <th>sum_ipa</th>
      <th>pshp_soundex_first</th>
      <th>...</th>
      <th>editex</th>
      <th>saps</th>
      <th>flexmetric</th>
      <th>jaro</th>
      <th>higueramico</th>
      <th>sift4</th>
      <th>eudex</th>
      <th>aline</th>
      <th>covington</th>
      <th>phoneticeditdistance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>51948</th>
      <td>Shah</td>
      <td>Tashe</td>
      <td>0</td>
      <td>shah</td>
      <td>tashe</td>
      <td>53</td>
      <td>20</td>
      <td>20</td>
      <td>0.838710</td>
      <td>0</td>
      <td>...</td>
      <td>0.300000</td>
      <td>0.0</td>
      <td>0.460000</td>
      <td>0.633333</td>
      <td>0.300000</td>
      <td>0.400000</td>
      <td>0.933824</td>
      <td>0.592593</td>
      <td>0.622222</td>
      <td>0.587097</td>
    </tr>
    <tr>
      <th>15602</th>
      <td>Aravindha</td>
      <td>Kim</td>
      <td>0</td>
      <td>aravindha</td>
      <td>kim</td>
      <td>43</td>
      <td>13</td>
      <td>13</td>
      <td>0.261649</td>
      <td>0</td>
      <td>...</td>
      <td>0.222222</td>
      <td>0.0</td>
      <td>0.255556</td>
      <td>0.481481</td>
      <td>0.000000</td>
      <td>0.111111</td>
      <td>0.745098</td>
      <td>0.187234</td>
      <td>0.300000</td>
      <td>0.288530</td>
    </tr>
    <tr>
      <th>4102</th>
      <td>Bart</td>
      <td>Almina</td>
      <td>0</td>
      <td>bart</td>
      <td>almina</td>
      <td>50</td>
      <td>17</td>
      <td>17</td>
      <td>0.655914</td>
      <td>0</td>
      <td>...</td>
      <td>0.083333</td>
      <td>0.0</td>
      <td>0.116667</td>
      <td>0.472222</td>
      <td>0.061905</td>
      <td>0.166667</td>
      <td>0.846078</td>
      <td>0.246667</td>
      <td>0.377551</td>
      <td>0.540323</td>
    </tr>
    <tr>
      <th>1384</th>
      <td>Tadzio</td>
      <td>Cecalie</td>
      <td>0</td>
      <td>tadzio</td>
      <td>cecalie</td>
      <td>67</td>
      <td>12</td>
      <td>12</td>
      <td>0.760753</td>
      <td>0</td>
      <td>...</td>
      <td>0.285714</td>
      <td>0.0</td>
      <td>0.528571</td>
      <td>0.539683</td>
      <td>0.232143</td>
      <td>0.285714</td>
      <td>0.922549</td>
      <td>0.515152</td>
      <td>0.546154</td>
      <td>0.755760</td>
    </tr>
    <tr>
      <th>2417</th>
      <td>Cat</td>
      <td>Kate</td>
      <td>1</td>
      <td>cat</td>
      <td>kate</td>
      <td>57</td>
      <td>50</td>
      <td>50</td>
      <td>1.000000</td>
      <td>1</td>
      <td>...</td>
      <td>0.625000</td>
      <td>0.0</td>
      <td>0.850000</td>
      <td>0.722222</td>
      <td>0.500000</td>
      <td>0.500000</td>
      <td>0.868627</td>
      <td>0.700000</td>
      <td>0.671429</td>
      <td>0.741935</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 28 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">target</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/tmp/ipykernel_2358187/1973277800.py:2: FutureWarning: In a future version of pandas all arguments of DataFrame.drop except for the argument &#39;labels&#39; will be keyword-only
  X = df.drop(&#39;target&#39;,1)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Model-building">Model building<a class="anchor-link" href="#Model-building"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MaxAbsScaler</span><span class="p">,</span> <span class="n">MinMaxScaler</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base_model_1</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">MaxAbsScaler</span><span class="p">(),</span>
    <span class="n">MinMaxScaler</span><span class="p">(),</span>
    <span class="n">RandomForestClassifier</span><span class="p">(</span>
                <span class="n">bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">criterion</span><span class="o">=</span><span class="s2">&quot;gini&quot;</span><span class="p">,</span>
            <span class="n">max_features</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
            <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>


<span class="n">stratified_kfold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fold</span> <span class="o">=</span> <span class="mi">1</span>


<span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stratified_kfold</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)):</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
    
    <span class="n">oof_pred</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[[</span><span class="s1">&#39;name_a&#39;</span><span class="p">,</span> <span class="s1">&#39;name_b&#39;</span><span class="p">]]</span>
    <span class="n">base_model_1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;name_a&#39;</span><span class="p">,</span> <span class="s1">&#39;name_b&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="n">oof_pred</span><span class="p">[</span><span class="s1">&#39;predict_proba&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_model_1</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;name_a&#39;</span><span class="p">,</span> <span class="s1">&#39;name_b&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="n">oof_pred</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;completed fold </span><span class="si">{}</span><span class="s1"> of 10&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fold</span><span class="p">))</span>
    <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/tmp/ipykernel_2358187/1107818783.py:12: FutureWarning: In a future version of pandas all arguments of DataFrame.drop except for the argument &#39;labels&#39; will be keyword-only
  base_model_1.fit(X_train.drop([&#39;a&#39;, &#39;b&#39;, &#39;name_a&#39;, &#39;name_b&#39;], 1), y_train)
/tmp/ipykernel_2358187/1107818783.py:14: FutureWarning: In a future version of pandas all arguments of DataFrame.drop except for the argument &#39;labels&#39; will be keyword-only
  oof_pred[&#39;predict_proba&#39;] = base_model_1.predict_proba(X_test.drop([&#39;a&#39;, &#39;b&#39;, &#39;name_a&#39;, &#39;name_b&#39;], 1))
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/core/indexes/base.py</span> in <span class="ansi-cyan-fg">get_loc</span><span class="ansi-blue-fg">(self, key, method, tolerance)</span>
<span class="ansi-green-intense-fg ansi-bold">   3360</span>             <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 3361</span><span class="ansi-red-fg">                 </span><span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_engine<span class="ansi-blue-fg">.</span>get_loc<span class="ansi-blue-fg">(</span>casted_key<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   3362</span>             <span class="ansi-green-fg">except</span> KeyError <span class="ansi-green-fg">as</span> err<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/_libs/index.pyx</span> in <span class="ansi-cyan-fg">pandas._libs.index.IndexEngine.get_loc</span><span class="ansi-blue-fg">()</span>

<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/_libs/index.pyx</span> in <span class="ansi-cyan-fg">pandas._libs.index.IndexEngine.get_loc</span><span class="ansi-blue-fg">()</span>

<span class="ansi-green-fg">pandas/_libs/hashtable_class_helper.pxi</span> in <span class="ansi-cyan-fg">pandas._libs.hashtable.PyObjectHashTable.get_item</span><span class="ansi-blue-fg">()</span>

<span class="ansi-green-fg">pandas/_libs/hashtable_class_helper.pxi</span> in <span class="ansi-cyan-fg">pandas._libs.hashtable.PyObjectHashTable.get_item</span><span class="ansi-blue-fg">()</span>

<span class="ansi-red-fg">KeyError</span>: &#39;predict_proba&#39;

The above exception was the direct cause of the following exception:

<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/core/frame.py</span> in <span class="ansi-cyan-fg">_set_item_mgr</span><span class="ansi-blue-fg">(self, key, value)</span>
<span class="ansi-green-intense-fg ansi-bold">   3745</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 3746</span><span class="ansi-red-fg">             </span>loc <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_info_axis<span class="ansi-blue-fg">.</span>get_loc<span class="ansi-blue-fg">(</span>key<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   3747</span>         <span class="ansi-green-fg">except</span> KeyError<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/core/indexes/base.py</span> in <span class="ansi-cyan-fg">get_loc</span><span class="ansi-blue-fg">(self, key, method, tolerance)</span>
<span class="ansi-green-intense-fg ansi-bold">   3362</span>             <span class="ansi-green-fg">except</span> KeyError <span class="ansi-green-fg">as</span> err<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 3363</span><span class="ansi-red-fg">                 </span><span class="ansi-green-fg">raise</span> KeyError<span class="ansi-blue-fg">(</span>key<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">from</span> err
<span class="ansi-green-intense-fg ansi-bold">   3364</span> 

<span class="ansi-red-fg">KeyError</span>: &#39;predict_proba&#39;

During handling of the above exception, another exception occurred:

<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">/tmp/ipykernel_2358187/1107818783.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     12</span>     base_model_1<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>X_train<span class="ansi-blue-fg">.</span>drop<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;a&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;b&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;name_a&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;name_b&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> y_train<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     13</span> 
<span class="ansi-green-fg">---&gt; 14</span><span class="ansi-red-fg">     </span>oof_pred<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;predict_proba&#39;</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> base_model_1<span class="ansi-blue-fg">.</span>predict_proba<span class="ansi-blue-fg">(</span>X_test<span class="ansi-blue-fg">.</span>drop<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;a&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;b&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;name_a&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;name_b&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     15</span> 
<span class="ansi-green-intense-fg ansi-bold">     16</span>     oof_pred<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;target&#39;</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> y_test<span class="ansi-blue-fg">.</span>tolist<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/core/frame.py</span> in <span class="ansi-cyan-fg">__setitem__</span><span class="ansi-blue-fg">(self, key, value)</span>
<span class="ansi-green-intense-fg ansi-bold">   3605</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   3606</span>             <span class="ansi-red-fg"># set column</span>
<span class="ansi-green-fg">-&gt; 3607</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_set_item<span class="ansi-blue-fg">(</span>key<span class="ansi-blue-fg">,</span> value<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   3608</span> 
<span class="ansi-green-intense-fg ansi-bold">   3609</span>     <span class="ansi-green-fg">def</span> _setitem_slice<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> key<span class="ansi-blue-fg">:</span> slice<span class="ansi-blue-fg">,</span> value<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/core/frame.py</span> in <span class="ansi-cyan-fg">_set_item</span><span class="ansi-blue-fg">(self, key, value)</span>
<span class="ansi-green-intense-fg ansi-bold">   3790</span>                     value <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>tile<span class="ansi-blue-fg">(</span>value<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>existing_piece<span class="ansi-blue-fg">.</span>columns<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>T
<span class="ansi-green-intense-fg ansi-bold">   3791</span> 
<span class="ansi-green-fg">-&gt; 3792</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>_set_item_mgr<span class="ansi-blue-fg">(</span>key<span class="ansi-blue-fg">,</span> value<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   3793</span> 
<span class="ansi-green-intense-fg ansi-bold">   3794</span>     def _set_value(

<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/core/frame.py</span> in <span class="ansi-cyan-fg">_set_item_mgr</span><span class="ansi-blue-fg">(self, key, value)</span>
<span class="ansi-green-intense-fg ansi-bold">   3747</span>         <span class="ansi-green-fg">except</span> KeyError<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   3748</span>             <span class="ansi-red-fg"># This item wasn&#39;t present, just insert at end</span>
<span class="ansi-green-fg">-&gt; 3749</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_mgr<span class="ansi-blue-fg">.</span>insert<span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_info_axis<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> key<span class="ansi-blue-fg">,</span> value<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   3750</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   3751</span>             self<span class="ansi-blue-fg">.</span>_iset_item_mgr<span class="ansi-blue-fg">(</span>loc<span class="ansi-blue-fg">,</span> value<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/core/internals/managers.py</span> in <span class="ansi-cyan-fg">insert</span><span class="ansi-blue-fg">(self, loc, item, value)</span>
<span class="ansi-green-intense-fg ansi-bold">   1153</span>             value <span class="ansi-blue-fg">=</span> ensure_block_shape<span class="ansi-blue-fg">(</span>value<span class="ansi-blue-fg">,</span> ndim<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>ndim<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1154</span> 
<span class="ansi-green-fg">-&gt; 1155</span><span class="ansi-red-fg">         </span>block <span class="ansi-blue-fg">=</span> new_block<span class="ansi-blue-fg">(</span>values<span class="ansi-blue-fg">=</span>value<span class="ansi-blue-fg">,</span> ndim<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>ndim<span class="ansi-blue-fg">,</span> placement<span class="ansi-blue-fg">=</span>slice<span class="ansi-blue-fg">(</span>loc<span class="ansi-blue-fg">,</span> loc <span class="ansi-blue-fg">+</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1156</span> 
<span class="ansi-green-intense-fg ansi-bold">   1157</span>         <span class="ansi-green-fg">for</span> blkno<span class="ansi-blue-fg">,</span> count <span class="ansi-green-fg">in</span> _fast_count_smallints<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>blknos<span class="ansi-blue-fg">[</span>loc<span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/core/internals/blocks.py</span> in <span class="ansi-cyan-fg">new_block</span><span class="ansi-blue-fg">(values, placement, ndim, klass)</span>
<span class="ansi-green-intense-fg ansi-bold">   1920</span> 
<span class="ansi-green-intense-fg ansi-bold">   1921</span>     values<span class="ansi-blue-fg">,</span> _ <span class="ansi-blue-fg">=</span> extract_pandas_array<span class="ansi-blue-fg">(</span>values<span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> ndim<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">-&gt; 1922</span><span class="ansi-red-fg">     </span>check_ndim<span class="ansi-blue-fg">(</span>values<span class="ansi-blue-fg">,</span> placement<span class="ansi-blue-fg">,</span> ndim<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1923</span> 
<span class="ansi-green-intense-fg ansi-bold">   1924</span>     <span class="ansi-green-fg">if</span> klass <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/Envs/venv/lib/python3.9/site-packages/pandas/core/internals/blocks.py</span> in <span class="ansi-cyan-fg">check_ndim</span><span class="ansi-blue-fg">(values, placement, ndim)</span>
<span class="ansi-green-intense-fg ansi-bold">   1962</span>             )
<span class="ansi-green-intense-fg ansi-bold">   1963</span>         <span class="ansi-green-fg">if</span> len<span class="ansi-blue-fg">(</span>placement<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">!=</span> len<span class="ansi-blue-fg">(</span>values<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1964</span><span class="ansi-red-fg">             raise ValueError(
</span><span class="ansi-green-intense-fg ansi-bold">   1965</span>                 <span class="ansi-blue-fg">f&#34;Wrong number of items passed {len(values)}, &#34;</span>
<span class="ansi-green-intense-fg ansi-bold">   1966</span>                 <span class="ansi-blue-fg">f&#34;placement implies {len(placement)}&#34;</span>

<span class="ansi-red-fg">ValueError</span>: Wrong number of items passed 2, placement implies 1</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

